#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

INSTALL_LOG="/var/log/mautic_install.log"

log() {
	echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$INSTALL_LOG"
}

if [ -f "/var/www/html/config/local.php" ]; then
	log "‚úÖ Mautic already installed ‚Äî skipping installation."
else
	log "üöÄ No installation found ‚Äî running Mautic installer."

	if ! php bin/console mautic:install \
		--db_driver=pdo_mysql \
		--db_host="$MAUTIC_DB_HOST" \
		--db_port="$MAUTIC_DB_PORT" \
		--db_name="$MAUTIC_DB_DATABASE" \
		--db_user="$MAUTIC_DB_USER" \
		--db_password="$MAUTIC_DB_PASSWORD" \
		--admin_firstname="$MAUTIC_ADMIN_FIRSTNAME" \
		--admin_lastname="$MAUTIC_ADMIN_LASTNAME" \
		--admin_username="$MAUTIC_ADMIN_USERNAME" \
		--admin_email="$MAUTIC_ADMIN_EMAIL" \
		--admin_password="$MAUTIC_ADMIN_PASSWORD" \
		--mailer_from_name="Mautic" \
		--mailer_from_email="$MAUTIC_ADMIN_EMAIL" \
		--mailer_transport=smtp \
		--mailer_host="$SMTP_HOST" \
		--mailer_port="$SMTP_PORT" \
		--mailer_user="$SMTP_USERNAME" \
		--mailer_password="$SMTP_PASSWORD" \
		--mailer_encryption="$SMTP_ENCRYPTION" \
		--mailer_auth_mode=login 2>&1 | tee -a "$INSTALL_LOG"; then
		log "‚ö†Ô∏è  Mautic installation command returned an error. Continuing anyway."
	fi
fi

# Run migrations safely ‚Äî skip errors like 'table does not exist'
log "üì¶ Running database migrations (ignoring non-critical errors)..."
if ! php bin/console doctrine:migrations:migrate \
	--no-interaction \
	--no-all-or-nothing \
	--allow-no-migration 2>&1 | tee -a "$INSTALL_LOG"; then
	log "‚ö†Ô∏è  Some migrations failed. This is non-fatal. Continuing..."
fi

# Optional: run cache clear but ignore failures
log "üßπ Clearing cache..."
if ! php bin/console cache:clear 2>&1 | tee -a "$INSTALL_LOG"; then
	log "‚ö†Ô∏è  Cache clear failed. Continuing..."
fi

log "‚úÖ Mautic install/migration process complete."
